# Card Game 03 · Backend DEV

## 目标
实现新规则（无牌库/弃牌堆）的对战服务：支持 PVP 与 PVE（简单 AI），用 WebSocket 推送回合状态与结算，并记录每回合结果。

---

## 规则摘要（对齐 PRD）
- 牌型：仅 A / D / R。
- 无牌库、无弃牌堆；需要补牌时随机生成 A/D/R。
- 初始血量：双方 10。
- 总回合数：10 回合；任意一方血量 ≤ 0 立即结束。
- 第 10 回合结束后若未分胜负：血量高者胜，相同平局。
- 每回合手牌结构：2 张公开牌 + 1 张暗牌（仅自己可见）。
- 开局：每位玩家生成 3 张（2 张公开 + 1 张暗）。
- 回合流程（双方同时）：
  1) 从第 2 回合开始：补 1 张随机牌为暗牌，使手牌回到 3 张。
  2) 从 3 张中选择 1 张出牌。
  3) 同时揭示。
  4) 按对冲表结算一次血量变化（双方同时应用）。
  5) 未打出的 2 张留到下回合并变为公开牌。
- 记录：每回合仅记录一次结果（回合数、双方出牌、双方血量变化、结算后血量）。

### 对冲结算表（我方变化 / 对方变化）
| 我方 \ 对方 | A | D | R |
| --- | --- | --- | --- |
| A | -2 / -2 | -1 / 0 | +1 / -2 |
| D | 0 / -1 | -1 / -1 | 0 / +1 |
| R | -2 / +1 | +1 / 0 | 0 / 0 |

---

## 核心数据结构（建议）

### CardType
- `"A" | "D" | "R"`

### PlayerState
- `playerId: string`
- `name: string`
- `hp: number`
- `openCards: CardType[]` // 长度 2
- `hiddenCard: CardType | null` // 每回合新增 1 张暗牌
- `submitted: boolean` // 本回合是否已出牌
- `isBot: boolean`
- `ws: WebSocket | null`

### RoomState
- `roomId: string`
- `status: "waiting" | "playing" | "finished"`
- `round: number` // 1~10
- `players: PlayerState[]` // 1 或 2 人
- `actions: Record<playerId, { card: CardType, sourceIndex: 0|1|2 }>`
- `roundLogs: RoundLog[]`
- `awaitingConfirm: boolean`
- `confirmed: Set<playerId>`
- `botTimeout?: NodeJS.Timeout | null`

### RoundLog
- `round: number`
- `p1Card: CardType`
- `p2Card: CardType`
- `p1Delta: number`
- `p2Delta: number`
- `p1Hp: number`
- `p2Hp: number`

---

## 回合生命周期（后端逻辑）

### 1. 开局 / 开房
- `round = 1`，每位玩家生成 3 张牌：
  - `openCards = [card1, card2]`
  - `hiddenCard = card3`
- `status = "playing"`（PVP 满 2 人后开始；PVE 直接开始）
- 发送 `round_state` 给每位玩家：
  - 我方：`openCards + hiddenCard`
  - 对手：仅 `openCards`

### 2. 回合开始（round >= 2）
- 每位玩家补 1 张随机牌作为暗牌：`hiddenCard = randomCard()`
- 保留上回合未出的 2 张作为 `openCards`。

### 3. 出牌与揭示
- 客户端提交出牌（建议以 **索引** 或 **卡牌值**）：
  - `sourceIndex = 0|1|2` （0/1 为 openCards, 2 为 hidden）
  - `card = CardType`
- 当两人都提交后：
  - 同时揭示双方出牌
  - 依对冲表结算一次

### 4. 结算与留牌
- 计算 `delta`，更新 HP（可下限为 0 便于显示）。
- 未打出的 2 张变为 `openCards`：
  - 若暗牌未打出，则其公开。
- `hiddenCard = null`（等待下一回合补牌）
- 写入 `roundLogs` 一条。

### 5. 结束条件
- 任意一方 `hp <= 0`：立刻结束。
- 否则 `round === 10` 结束，按 HP 比较。

### 6. 进入下一回合
- 若未结束：`round += 1`，`awaitingConfirm = true`（可由客户端确认后进入下一回合）。

---

## WebSocket 协议（建议）

### 通用
- 连接路径：`/api/20250126-card_game03/ws`
- 发送格式：`{ type: string, payload?: object }`

### Client -> Server
- `start_bot { playerName }`
- `create_room { playerName, roomId? }`
- `join_room { roomId, playerName }`
- `play_card { roomId, playerId, round, sourceIndex, card? }`
- `round_confirm { roomId, playerId, round }`
- `rematch { roomId, playerId }`

### Server -> Client
- `room_created { roomId, playerId }`
- `room_joined { roomId, playerId }`
- `room_state { roomId, status, round, players:[{playerId,name,hp,submitted}] }`
- `round_state { roomId, round, my:{openCards, hiddenCard}, opp:{openCards}, requiredPickCount:1 }`
- `round_result { roomId, round, p1Id, p2Id, p1Card, p2Card, p1Delta, p2Delta, p1Hp, p2Hp }`
- `game_over { roomId, round, result, final:{p1:{hp}, p2:{hp}} }`
- `error { message }`

> `round_state` 只下发给玩家本人各自视角数据，确保暗牌不可见。

---

## AI（简单机器人）
- 规则：从 3 张里 **随机选 1 张**。
- 可加 500~1200ms 延迟模拟思考。

---

## 断线与异常处理
- 断线后可清房或等待重连（先按现有 game02 策略：房间人数不足则进入 waiting）。
- 非法操作：
  - `round mismatch`
  - `not in room`
  - `already submitted`
  - `invalid card / index`

---

## 开发步骤（后端）
1. 新建 `backend/projects/20250126-card_game03.js`，复制 game02 结构并精简规则与状态结构。
2. 实现 `randomCard()` 与 `resolveDelta()`，完成单回合结算与日志写入。
3. 完成 `round_state` 视角下发逻辑（隐牌不可见）。
4. 实现 PVP / PVE 流程（start_bot/create/join）。
5. 接入 `round_confirm` 与 `rematch`。
6. 自测：
   - 回合 1 初始化 3 张
   - 回合 2+ 补牌逻辑
   - 10 回合胜负判断 / HP ≤ 0 立即结束
   - 对冲结算表正确性

